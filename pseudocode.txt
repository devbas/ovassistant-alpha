trips = query('Select * from trips') 
date = new Date() 

foreach trips as trip: 
  trajectory = []
  shapes = query('Select * from shapes where shape_id = trip['shape_id'])
  stop_times = query('Select * from stop_times where trip_id = trip['trip_id'])

  // Point to point matching with two vertices (v1, v2) and a station (s1), as proposed by Brosi (2014)
  foreach stop_times as s1: 
    for(var i = 0; i < shapes.length - 1; i++) {
      v1 = shapes[i]
      if(v1['shape_dist_traveled'] && s1['shape_dist_traveled]) {
        if(v1['shape_dist_traveled] > s1['shape_dist_traveled]) {
          trajectory = trajectory.push({ lat: s1['shape_pt_lat'], lon: s1['shape_pt_lon'], arrival_time: s1['arrival_time']})
          break; 
        } else {
          trajectory = trajectory.push({ lat: v1['shape_pt_lat'], lon: v1['shape_pt_lon'] })
        }
      } else {
        // Merge waypoints 
      }
    }






Select * from shapes 

foreach shapes as shape: 
  select * from stop_times where shape_id = shape['shape_id']